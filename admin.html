<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>SmpTier — Admin</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<header class="header container">
  <img src="assets/logo.png" alt="logo" class="logo">
  <div><div class="brand">SmpTier</div><div class="lead">Espace admin</div></div>
  <nav><a href="index.html">Accueil</a><a href="criteres.html">Critères</a><a href="classement.html">Classement</a><a href="file-test.html">Tester mon SMP</a><a href="admin.html">Admin</a></nav>
</header>

<main class="container">
  <section class="card">
    <h2>Connexion admin</h2>
    <p class="lead">Zone admin <span class="kbd"></span>(Pour devenir évaluateur, faites un ticket sur le discord)</p>
    <button class="btn btn-primary" id="enter">Entrer admin</button>
  </section>

  <section class="grid grid-2" id="panel" style="display:none">
    <div class="card">
      <h3>Inscriptions en attente</h3>
      <div id="pendingList">Chargement…</div>
    </div>

    <div class="card">
      <h3>Classement public (éditer)</h3>
      <div id="publicList">Chargement…</div>
    </div>
  </section>
</main>

<script type="module">
import { requireAdminPassword } from './helpers.js';
import { db } from './firebase-init.js';
import {
  collection, query, where, onSnapshot, addDoc, deleteDoc, doc, getDocs, updateDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const enter = document.getElementById('enter');
const panel = document.getElementById('panel');
const pendingList = document.getElementById('pendingList');
const publicList = document.getElementById('publicList');

enter.addEventListener('click', ()=> {
  if(requireAdminPassword()){
    panel.style.display = 'grid';
    loadPending();
    loadPublic();
  }
});

function bindPendingActions(){
  document.querySelectorAll('.approveBtn').forEach(b=>{
    b.onclick = async ()=> {
      const id = b.dataset.id;
      const docRef = doc(db,'smp_inscriptions', id);
      // fetch doc data quickly
      const snap = await getDocs(query(collection(db,'smp_inscriptions')));
      let found=null;
      snap.forEach(d=>{ if(d.id===id) found=d; });
      if(!found) { alert('Données manquantes'); return; }
      const data = found.data();
      const tier = prompt('Attribue un Tier (1-5) :','3');
      if(!tier) return;
      await addDoc(collection(db,'smp_public'), {
        name: data.name, discord: data.discord, ip: data.ip||'', twist: data.twist||'', date: data.date||'', tier: Number(tier)||3, createdAt: serverTimestamp()
      });
      await deleteDoc(docRef);
      alert('SMP mis en public (classement).');
    };
  });
  document.querySelectorAll('.delBtn').forEach(b=>{
    b.onclick = async ()=> {
      const id = b.dataset.id;
      if(confirm('Supprimer cette inscription ?')) await deleteDoc(doc(db,'smp_inscriptions',id));
    };
  });
}

function bindPublicActions(){
  document.querySelectorAll('.editTier').forEach(b=>{
    b.onclick = async ()=>{
      const id = b.dataset.id;
      const newt = prompt('Nouveau Tier (1-5) ?','3');
      if(!newt) return;
      await updateDoc(doc(db,'smp_public',id), { tier: Number(newt)||3 });
    };
  });
  document.querySelectorAll('.removePub').forEach(b=>{
    b.onclick = async ()=>{
      const id = b.dataset.id;
      if(confirm('Supprimer du classement public ?')) await deleteDoc(doc(db,'smp_public',id));
    };
  });
}

function loadPending(){
  const q = query(collection(db,'smp_inscriptions'), where('status','==','pending'));
  onSnapshot(q, snap=>{
    pendingList.innerHTML='';
    if(snap.empty) pendingList.innerHTML='<p>Aucune inscription en attente</p>';
    snap.forEach(d=>{
      const x=d.data();
      pendingList.innerHTML += `<div style="margin-bottom:12px;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02)">
        <b>${x.name||'-'}</b> — ${x.discord||'-'} — ${x.ip||'-'}<br>
        Twist: ${x.twist||'-'} — Date: ${x.date||'-'}<br>
        <a href="test.html?token=${x.testToken}" target="_blank" class="kbd">Lien test</a>
        <div style="margin-top:8px">
          <button class="btn btn-primary approveBtn" data-id="${d.id}">Approuver</button>
          <button class="btn btn-ghost delBtn" data-id="${d.id}">Supprimer</button>
        </div>
      </div>`;
    });
    bindPendingActions();
  });
}

function loadPublic(){
  const q = query(collection(db,'smp_public'));
  onSnapshot(q, snap=>{
    publicList.innerHTML='';
    if(snap.empty) publicList.innerHTML='<p>Aucun SMP public</p>';
    snap.forEach(d=>{
      const x=d.data();
      publicList.innerHTML += `<div style="margin-bottom:12px;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02)">
        <b>${x.name}</b> — ${x.discord||'-'} — ${x.ip||'-'}<br>
        Twist: ${x.twist||'-'} — Date: ${x.date||'-'} — <span class="kbd">Tier ${x.tier||5}</span>
        <div style="margin-top:8px">
          <button class="btn btn-primary editTier" data-id="${d.id}">Modifier Tier</button>
          <button class="btn btn-danger removePub" data-id="${d.id}">Supprimer</button>
        </div>
      </div>`;
    });
    bindPublicActions();
  });
}
</script>

<footer class="footer">© 2025 SmpTier</footer>
</body>
</html>
